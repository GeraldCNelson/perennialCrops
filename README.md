# Perennial Crops - R and c++ code and data

## Description of the data and file structure
The data in the dryad site ([https://doi.org/10.48364/ISIMIP.842396.1](https://doi.org/10.48364/ISIMIP.842396.1)) should be used in conjunction with the code and small data sets in the Zenodo site ([https://doi.org/10.5281/zenodo.7539023](https://doi.org/10.5281/zenodo.7539023)) that contains all the R and c++ code and some additional small data sets to generate the results in the Global Change Biology, "Assessing temperature-based adaptation limits to climate change of temperate perennial fruit crops". The data downlaoded from the dryad site are in a 79GB zip file.

# Directory structure
The directory structure for the code is described below. The data from the dryad download arrives as a zip file that contains a directory with 54 items. 52 of these are individual climate data geotiff files (e.g., gfdl-esm4_tas_cropped_ssp585_2041_2060.tif). All of the climate data .tif files need to be moved to the climdata directory (see below). The other data are in a zip folder called chillPortions.zip. The contents of that folder need to be moved to the data/chillPortions directory (see below)
- climdata - climate data files. The ISIMIP project [https://www.isimip.org] prepares daily bias-corrected 1/2 degree resolution from five earth system models (ESMs - GFDL-ESM4, UKESM1-0-LL, MPI-ESM1-2-HR, MRI-ESM2-0, and IPSL-CM6A-LR). The paper uses the ISIMIP3b data from 
[https://doi.org/10.48364/ISIMIP.842396.1](https://doi.org/10.48364/ISIMIP.842396.1). The data are downloaed as netcdf files with 10 years of data 
- data-raw/geotiff - Contains geotiff files of early century crop areas for the five crops included in the paper - almond, apple, cherry, grape, and olive - created from data in [www.earthstat.org](http://www.earthstat.org). 
- data/chillPortions - The contents of the chillPortions.zip file should be put in this directory. They can also be generated with the R script 
  * perennials - an excel version of the data table in the supplementary materials of the paper
  * regionInformation - files used to construct the boarders used in the graphics
- data - processed data that are used to generate the final results. Generated by `chillingCalcs.R` and `chillPortions.R`
  * crops - raster mask files for each crop created from the earthstat data.
  * growingDegreeDays - daily growing degree days by ESM and ensemble means across the models, locations where growing degree days are not limiting for one of the crops.
  * perennials - various files related to crop specific suitability
  * runs - files with the results of calculations on the number of days with a value below or above a limit, a run.
- graphics - destination for graphics results

# Order of operations

## Install libraries

Here's some code to install any of the needed packages that are not already installed

`packages <- c("terra", "viridis", "data.table", "flextable", "officer", "crayon", "magrittr", "doParallel", "foreach", "Rcpp", "readxl")`
`installed_packages <- packages %in% rownames(installed.packages())`
`if (any(installed_packages == FALSE)) {  install.packages(packages[!installed_packages]) }`

The two figures for the paper use the pdf graphics driver built in to base R. The code used to produce Figure 1 and Figure 2 also uses the pdfcrop program to trim the white spaces around the edges of the pdf. 

For Mac users, run this code from a terminal to install pdfcrop. This uses the homebrew system (https://brew.sh). A plug - homebrew is a really nice way to manage all sorts of code that the MacOS should have but doesn't. It also works for linux users.
`brew install --cask mactex`

For windows users, these directions for installing pdfcrop might be  useful but haven't been verified.'

"You need first to install Perl support for Windows (for example https://www.activestate.com/activeperl) and after that use Miktex package manager to install pdfcrop."

More directions here [https://pdfcrop.sourceforge.net]

## Run scripts

- chillingCalcs.R - output the chilling portions file stored in data-raw. This will take a long time and the output files are already available. Run only if new versions are needed.
- perennialCalcs.R  - directions for running are included in the file. Read through the code before sourcing the file

The graphics for the paper are generated by the following files

- GCBPerennials_Figure_1.R
- GCBPerennials_Figure_2.R
- GCBPerennials_Table_4.R
- GCBPerennials_Table_5.R
- GCBPerennials_Table_7.R

Tables 1, 2, 6, and 6 are just word tables that are not generated in R.

